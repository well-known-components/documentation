<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Philosophy | Well Known Components</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="A different way to create boring applications">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/documentation/assets/css/0.styles.fdb13168.css" as="style"><link rel="preload" href="/documentation/assets/js/app.a37e55eb.js" as="script"><link rel="preload" href="/documentation/assets/js/2.91af1bd7.js" as="script"><link rel="preload" href="/documentation/assets/js/12.87a4d3cb.js" as="script"><link rel="prefetch" href="/documentation/assets/js/10.730e9d0f.js"><link rel="prefetch" href="/documentation/assets/js/11.552735b1.js"><link rel="prefetch" href="/documentation/assets/js/13.b4885c12.js"><link rel="prefetch" href="/documentation/assets/js/14.81cf27f4.js"><link rel="prefetch" href="/documentation/assets/js/15.75a0678f.js"><link rel="prefetch" href="/documentation/assets/js/16.a317ebf2.js"><link rel="prefetch" href="/documentation/assets/js/3.57036479.js"><link rel="prefetch" href="/documentation/assets/js/4.95ec17ab.js"><link rel="prefetch" href="/documentation/assets/js/5.7ec961d8.js"><link rel="prefetch" href="/documentation/assets/js/6.17d5dd20.js"><link rel="prefetch" href="/documentation/assets/js/7.33a5751e.js"><link rel="prefetch" href="/documentation/assets/js/8.aec57476.js"><link rel="prefetch" href="/documentation/assets/js/9.f522ea37.js">
    <link rel="stylesheet" href="/documentation/assets/css/0.styles.fdb13168.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/documentation/" class="home-link router-link-active"><!----> <span class="site-name">Well Known Components</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/documentation/docs/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="/documentation/config/" class="nav-link">
  Config
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/documentation/docs/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="/documentation/config/" class="nav-link">
  Config
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/documentation/docs/" class="sidebar-heading clickable router-link-active open"><span>Documentation</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/documentation/docs/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/documentation/docs/philosophy.html" aria-current="page" class="active sidebar-link">Philosophy</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/documentation/docs/philosophy.html#start-planning-the-use-cases" class="sidebar-link">Start planning the use cases</a></li><li class="sidebar-sub-header"><a href="/documentation/docs/philosophy.html#what-are-components" class="sidebar-link">What are components?</a></li><li class="sidebar-sub-header"><a href="/documentation/docs/philosophy.html#ports" class="sidebar-link">Ports</a></li><li class="sidebar-sub-header"><a href="/documentation/docs/philosophy.html#adapters" class="sidebar-link">Adapters</a></li><li class="sidebar-sub-header"><a href="/documentation/docs/philosophy.html#controllers" class="sidebar-link">Controllers</a></li><li class="sidebar-sub-header"><a href="/documentation/docs/philosophy.html#development-approach" class="sidebar-link">Development approach</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/documentation/ports/" class="sidebar-heading clickable"><span>Libraries (Ports)</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/documentation/ports/" class="sidebar-link">@well-known-components</a></li><li><a href="/documentation/ports/lifecycle.html" class="sidebar-link">Lifecycle</a></li><li><a href="/documentation/ports/http-server.html" class="sidebar-link">http-server</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="philosophy"><a href="#philosophy" class="header-anchor">#</a> Philosophy</h1> <h2 id="start-planning-the-use-cases"><a href="#start-planning-the-use-cases" class="header-anchor">#</a> Start planning the use cases</h2> <p>E.g:</p> <ol><li>Whenever we receive a message on the message queue, we should store it using the message topic as key.</li> <li>The HTTP service must serve the most recient value of every received message key.</li></ol> <p>To do so, we create two handlers for our business logic:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// caches every incoming message</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mqHandler</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> TopicMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>topic<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// returns a cached value received from the MQ</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">httpRequestHandler</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>That should be it, that is the whole business.</p> <p>This specific example is trivial, but it works to make visible some common patterns that can explode in complexity making the whole service hard to test. In this particular case, testing may be complicated because: it assumes that a <code>cache</code> variable exists somehow in a &quot;global&quot; environment.</p> <p>To make it a little bit more testable we are going to define simple <em>cache <strong>component</strong></em>.</p> <h2 id="what-are-components"><a href="#what-are-components" class="header-anchor">#</a> What are components?</h2> <p>A component is an interface containing functions. In languages supporting classes, it could be an instance of a class. Returning plain objects with functions also works perfectly.</p> <p>We are going to define a simple interface for our <em>cache component</em>.</p> <p>⚠️ At this stage, we are not deciding which type of cache we are using. We only describe a protocol, an interface for it. That interface is the <em>component</em>.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">ICacheComponent</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then we will provide the <em>cache component</em> the previously created handlers:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// caches every incoming message</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mqHandler</span><span class="token punctuation">(</span>cache<span class="token operator">:</span> ICacheComponent<span class="token punctuation">,</span> msg<span class="token operator">:</span> TopicMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//                     ^^^^^^^^^^^^^^^^^^^^^^</span>
  <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>topic<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// returns a cached value received from the MQ</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">httpRequestHandler</span><span class="token punctuation">(</span>cache<span class="token operator">:</span> ICacheComponent<span class="token punctuation">,</span> request<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//                              ^^^^^^^^^^^^^^^^^^^^^^</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>That is way more testable. <code>cache</code> is no longer a magical global variable. Now it would be trivial to test it with the tool of choice:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;should store messages&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token function">createCacheInMemoryMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">mqHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> <span class="token punctuation">{</span> topic<span class="token operator">:</span> <span class="token string">&quot;/hi&quot;</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">&quot;test&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/hi&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;should serve stored messages&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token function">createCacheInMemoryMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  cache<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;/hi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test123&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">httpRequestHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token string">&quot;/hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body <span class="token operator">==</span> <span class="token string">&quot;test123&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// helper function to mock the component</span>
<span class="token keyword">function</span> <span class="token function">createCacheInMemoryMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ICacheComponent <span class="token punctuation">{</span>
  <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      map<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="take-away"><a href="#take-away" class="header-anchor">#</a> Take away</h4> <p>We have implemented all of our business logic without making <em>any</em> technology decision. There is no mechanism in markdown to emphatize this sentence as much as I'd like, this is huge. The whole business logic is easyly testable and completely decoupled from bikeshedding discussions and libraries. We did not talk about which server we are going to use, we don't know if the MQ is Kafka, AMQP, SQS or UDP messages or messaging pidgeons.</p> <h2 id="ports"><a href="#ports" class="header-anchor">#</a> Ports</h2> <p><strong>Ports are the implementation of the components</strong>. Is the result of invoking a function that returns the actual <code>cache</code> that we will pass to the functions.</p> <p>Ports could be part of our program to begin with, and a good practice is to extract the ports into their own repository as soon as the API (the component) is stable. To enable other teams or projects to leverage the port.</p> <h2 id="adapters"><a href="#adapters" class="header-anchor">#</a> Adapters</h2> <p>Adapters are pure functions that transforms external data from ports into our internal usable representation <code>fn(rawPortData) -&gt; ApplicationData</code>.</p> <p>A good example is the adapters for Postgress queries. Every record returned by Postgres uses underscores, but depending on the conventions, we normally use camelCase for our records.</p> <p>It is recommended that everything is well typed, and that our services have a cannonical representation of the data that does not change with the exposed APIs, and it is consistent no matter which port or component are we using. An example is the schema of a notification. It shouldn't matter whether the notification arrives from SNS, a message queue or UDP message. Or if it is encoded as JSON, XML or ProtocolBuffer. Our service should have a cannonical <code>Notification</code> type that is always consistent. To do that, we use the Adapters, from the hexagonal architecture. Adapters abstract us from the subtleties of every port and their protocols to have cannonical representations of our data.</p> <h2 id="controllers"><a href="#controllers" class="header-anchor">#</a> Controllers</h2> <p>The &quot;glue&quot; between all the other layers, orchestrating calls between pure business logic, adapters, and ports.</p> <p>Controllers always receive an hydrated context containing components and parameters to call the business logic.</p> <h2 id="development-approach"><a href="#development-approach" class="header-anchor">#</a> Development approach</h2> <p>The goal of the initiative, is to enable docummented and consistent creation of services, using reusable pieces (components) in a seamlessly way while keeping the whole thing testable and maintainable. Often projects explode in complexity because they rely on mountains of constructs and abstraction patterns. While leveraging simple constructs like functions and records (ports) might make things simpler.</p> <p>To create big systems the proposal goes as follows:</p> <ol><li><strong>Define the use cases of the microservice</strong>:<br>
E.g: React to messages, store the messages in a caché, expose the caché using HTTP endpoints.</li> <li><strong>Create a set of well-known interfaces, the components.</strong><br>
That way, you can defer the responsibilitiy of creating the <code>KafkaComponent</code> or <code>KafkaTestComponent</code> to the &quot;kafka-team&quot; and let them maintain the library and do what they do best.</li> <li><strong>Put all the components in a typed record and pass it over to all the handlers.</strong><br>
It works best if you also create specialized types or schemas for every specific handler. We will see an example of that later.</li> <li><strong>Initialize the components at the begining.</strong><br>
In my personal experience, this works best in an explicit piece of code, a function, to initialize the components. Otherwise you can leverage tools to do the same i.e. <a href="https://github.com/stuartsierra/component" target="_blank" rel="noopener noreferrer">stuartsierra/components<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li><strong>Wire components together, focus on the business logic.</strong><br>
Business logic is the most important part of any application or service you will ever create. This framework will remove you the load of dealing with technology decisions and will provide you and your team more time to focus on what matters the most.</li></ol> <h3 id="_1-define-the-use-cases-of-the-microservice"><a href="#_1-define-the-use-cases-of-the-microservice" class="header-anchor">#</a> 1. Define the use cases of the microservice</h3> <p>This is on you. For our example, the use cases are:</p> <ol><li>Whenever we receive a message on the message queue, we should store it using the message topic as key.</li> <li>The HTTP service must serve the most recient value of every received message key.</li></ol> <h3 id="_2-create-a-set-of-well-known-interfaces-the-components"><a href="#_2-create-a-set-of-well-known-interfaces-the-components" class="header-anchor">#</a> 2. Create a set of well-known interfaces, the components</h3> <p>There are many approaches to do this, you could either create a library for common interfaces that is shared across your team's projects. Or define them manually. In this example, we are going to define the components in a file called <code>components.ts</code></p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// components.ts</span>

<span class="token comment">// caché handling</span>
<span class="token keyword">interface</span> <span class="token class-name">ICacheComponent</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token comment">// a handler to consume queues</span>
<span class="token keyword">interface</span> <span class="token class-name">TopicMessage</span> <span class="token punctuation">{</span>
  topic<span class="token operator">:</span> <span class="token builtin">string</span>
  content<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">IMessageQueue<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token function">onMessage</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> msg<span class="token operator">:</span> TopicMessage<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>

<span class="token comment">// a simple handler for http requests</span>
<span class="token keyword">interface</span> <span class="token class-name">IHttpServer<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token function">onRequest</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> msg<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Response<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>

<span class="token comment">// a configuration provider</span>
<span class="token keyword">interface</span> <span class="token class-name">IConfig</span> <span class="token punctuation">{</span>
  <span class="token function">requireString</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span>
  <span class="token function">requireNumber</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-put-all-the-components-in-a-typed-record-context-and-pass-it-over-to-all-the-handlers"><a href="#_3-put-all-the-components-in-a-typed-record-context-and-pass-it-over-to-all-the-handlers" class="header-anchor">#</a> 3. Put all the components in a typed record (context) and pass it over to all the handlers</h3> <p>Keep this context record visible and available for other files, it will become handy, this context record describes all the components required and avaliable for your application</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">type</span> <span class="token class-name">ApplicationContext</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  config<span class="token operator">:</span> IConfig
  cache<span class="token operator">:</span> ICacheComponent
  mq<span class="token operator">:</span> IMessageQueue<span class="token operator">&lt;</span>ApplicationContext<span class="token operator">&gt;</span>
  httpServer<span class="token operator">:</span> IHttpServer<span class="token operator">&lt;</span>ApplicationContext<span class="token operator">&gt;</span>
  <span class="token comment">// logger</span>
  <span class="token comment">// db</span>
  <span class="token comment">// etc</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-initialize-the-components-at-the-begining"><a href="#_4-initialize-the-components-at-the-begining" class="header-anchor">#</a> 4. Initialize the components at the begining</h3> <p>At the beginning of your application or testing environment, you should create all the components required by your application to work. Often, some components will depend on eachother, like the <code>config</code> component, it may be used by several other components to handle proper initialization. Or you may need to manually access it to configure i.e. the listening port of an HTTP server.</p> <p>To do so, there are libraries to resolve graphs or inject dependencies.</p> <p>Our approach is more manual and verbosic, simple functions handling the component creation are enough in most cases, and also very easy to debug and trace.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// components.ts</span>

<span class="token comment">// create the production components</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">initializeComponents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ApplicationContext <span class="token punctuation">{</span>
  <span class="token comment">// initialize config component using the process environment variables</span>
  <span class="token keyword">const</span> config<span class="token operator">:</span> IConfig <span class="token operator">=</span> <span class="token function">createConfigProvider</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">)</span>

  <span class="token comment">// initialize HTTP server</span>
  <span class="token keyword">const</span> httpServer<span class="token operator">:</span> IHttpServer<span class="token operator">&lt;</span>ApplicationContext<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">createHttpServer</span><span class="token punctuation">(</span><span class="token keyword">await</span> config<span class="token punctuation">.</span><span class="token function">requireNumber</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// initialize message queue consumer</span>
  <span class="token keyword">const</span> mq<span class="token operator">:</span> IMessageQueue<span class="token operator">&lt;</span>ApplicationContext<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">createMq</span><span class="token punctuation">(</span><span class="token keyword">await</span> config<span class="token punctuation">.</span><span class="token function">requireString</span><span class="token punctuation">(</span><span class="token string">&quot;mq_url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// initialize in-memory cache</span>
  <span class="token keyword">const</span> cache<span class="token operator">:</span> ICacheComponent <span class="token operator">=</span> <span class="token function">createMemoryCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// createRedisCache(await config.requireString('redis_url'))</span>

  <span class="token comment">// return all the components for the app</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">,</span>
    httpServer<span class="token punctuation">,</span>
    mq<span class="token punctuation">,</span>
    cache<span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> ApplicationContext
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-wire-components-together-focus-on-the-business-logic"><a href="#_5-wire-components-together-focus-on-the-business-logic" class="header-anchor">#</a> 5. Wire components together, focus on the business logic</h3> <p>Write the glue code using the components to achieve business results. We call the &quot;wiring&quot; part of our services <em>the controllers</em>, a familiar concept.</p> <p>This framework is heavily inspired by Hexagonal Architecture, where the components instances are ports, and the business logic live in controllers, legeraging adapters + core logic.</p> <p>The controllers connect several components together to achieve an use case. The first examples in this document were the controllers, the handler functions. Then we need to wire the handlers to the ports, and that process is called &quot;wiring&quot;.</p> <p>The controllers (handlers) will receive only the context they need. That makes testability easier when using static typing, because there is no need to pass unwanted or unused components to a handler.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// handlers.ts</span>

<span class="token comment">// subset of components for the mq handler</span>
<span class="token keyword">type</span> <span class="token class-name">MqHandlerContext</span> <span class="token operator">=</span> Pick<span class="token operator">&lt;</span>ApplicationContext<span class="token punctuation">,</span> <span class="token string">&quot;cache&quot;</span><span class="token operator">&gt;</span>

<span class="token comment">// subset of components for the http handler</span>
<span class="token keyword">type</span> <span class="token class-name">HttpHandlerContext</span> <span class="token operator">=</span> Pick<span class="token operator">&lt;</span>ApplicationContext<span class="token punctuation">,</span> <span class="token string">&quot;cache&quot;</span><span class="token operator">&gt;</span>

<span class="token keyword">function</span> <span class="token function">mqHandler</span><span class="token punctuation">(</span>components<span class="token operator">:</span> MqHandlerContext<span class="token punctuation">,</span> msg<span class="token operator">:</span> TopicMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// caches every incoming message</span>
  <span class="token keyword">await</span> components<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>topic<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">httpRequestHandler</span><span class="token punctuation">(</span>components<span class="token operator">:</span> HttpHandlerContext<span class="token punctuation">,</span> request<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// returns a cached value received from the MQ</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>components<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally, some code is needed to create the components and wire the application</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// main.ts</span>

<span class="token comment">// initialize and wire components</span>
<span class="token keyword">function</span> <span class="token function">initControllers</span><span class="token punctuation">(</span>context<span class="token operator">:</span> ApplicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span>mq<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mqHandler<span class="token punctuation">)</span>
  context<span class="token punctuation">.</span>httpServer<span class="token punctuation">.</span><span class="token function">onRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> httpRequestHandler<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// main entry point of our application</span>
<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context<span class="token operator">:</span> ApplicationContext <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">initializeComponents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">initControllers</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// fail if some error is triggered during initialization</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/documentation/docs/" class="prev router-link-active">
        Introduction
      </a></span> <span class="next"><a href="/documentation/ports/">
        @well-known-components
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/documentation/assets/js/app.a37e55eb.js" defer></script><script src="/documentation/assets/js/2.91af1bd7.js" defer></script><script src="/documentation/assets/js/12.87a4d3cb.js" defer></script>
  </body>
</html>
